<div class="container mx-auto max-w-2xl px-4 py-8">
  <div class="workouts mb-10">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-semibold text-black">Your last workout</h2>
      <button
        (click)="logWorkout()"
        [disabled]="hasLoggedToday()"
        class="btn-primary px-4 py-2 text-sm disabled:opacity-60 disabled:cursor-not-allowed"
      >
        {{ hasLoggedToday() ? 'Already logged today' : 'Log a workout' }}
      </button>
    </div>
    <div
      class="mb-6 p-4 rounded-md border border-gray-150 bg-gray-50 shadow-[0_1px_2px_0_rgba(0,0,0,0.03)]"
    >
      @if (!timeSinceLastWorkout().hasWorkout) {
      <div
        class="flex items-center justify-center py-6 rounded-lg bg-gray-100 border border-gray-200"
      >
        <span class="text-gray-600 font-medium"
          >No workouts yet — start your journey!</span
        >
      </div>
      } @else {

      <div class="grid grid-cols-4 gap-3 mb-4">
        <div
          class="bg-white flex flex-col items-center justify-center border border-gray-200 rounded-lg px-2 py-6 shadow-sm"
        >
          <div class="text-2xl font-bold text-black">
            {{ timeSinceLastWorkout().days }}
          </div>
          <div class="text-xs uppercase tracking-wider text-gray-500 mt-1">
            Days
          </div>
        </div>
        <div
          class="bg-white flex flex-col items-center justify-center border border-gray-200 rounded-lg px-2 py-6 shadow-sm"
        >
          <div class="text-2xl font-bold text-black">
            {{ timeSinceLastWorkout().hours | number:'2.0-0' }}
          </div>
          <div class="text-xs uppercase tracking-wider text-gray-500 mt-1">
            Hours
          </div>
        </div>
        <div
          class="bg-white flex flex-col items-center justify-center border border-gray-200 rounded-lg px-2 py-6 shadow-sm"
        >
          <div class="text-2xl font-bold text-black">
            {{ timeSinceLastWorkout().minutes | number:'2.0-0' }}
          </div>
          <div class="text-xs uppercase tracking-wider text-gray-500 mt-1">
            Minutes
          </div>
        </div>
        <div
          class="bg-white flex flex-col items-center justify-center border border-gray-200 rounded-lg px-2 py-6 shadow-sm"
        >
          <div class="text-2xl font-bold text-black">
            {{ timeSinceLastWorkout().seconds | number:'2.0-0' }}
          </div>
          <div class="text-xs uppercase tracking-wider text-gray-500 mt-1">
            Seconds
          </div>
        </div>
      </div>

      @if (currentStreak() > 0 || longestStreak() > 0) {
      <div class="flex items-center justify-center">
        <div
          class="flex flex-col items-center justify-center p-2 bg-slate-800 rounded-lg w-fit shadow-sm text-balloon"
        >
          <p class="text-xs font-medium text-white text-center">
            Hit your weekly goal to keep your streak!
          </p>
        </div>
      </div>
      <div class="flex items-center justify-center gap-3 mt-3 flex-wrap">
        @if (currentStreak() > 0) {
        <span
          class="inline-flex items-center gap-1.5 text-xs font-semibold text-black"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 20 20"
            fill="currentColor"
            class="w-4 h-4 text-amber-500"
            aria-hidden="true"
          >
            <path
              fill-rule="evenodd"
              d="M12.963 2.286a.75.75 0 0 0-1.071-.136 9.742 9.742 0 0 0-3.539 6.177 7.547 7.547 0 0 1-1.705-1.715.75.75 0 0 0-1.152-.082A9 9 0 1 0 15.68 4.534a7.46 7.46 0 0 1-2.717-2.248Z"
              clip-rule="evenodd"
            />
          </svg>
          {{ currentStreak() }} {{ currentStreak() === 1 ? 'week' : 'weeks' }}
        </span>
        } @if (longestStreak() > 0) {
        <span class="text-xs text-gray-500"
          >Longest: {{ longestStreak() }} {{ longestStreak() === 1 ? 'week' :
          'weeks' }}</span
        >
        }
      </div>
      } @else {
      <div class="flex items-center justify-center">
        <div
          class="flex flex-col items-center justify-center p-2 bg-slate-800 rounded-lg w-fit shadow-sm text-balloon"
        >
          <p class="text-xs font-medium text-white text-center">
            Time to start your first streak!
          </p>
        </div>
      </div>
      } }
    </div>
    @if (weeklyProgress(); as wp) {
    <div class="mb-6 rounded-lg border border-gray-200 bg-white p-4 shadow-sm">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-base font-semibold text-black">Weekly goal</h2>
        <button
          type="button"
          (click)="openGoalEditor()"
          class="text-xs font-medium text-gray-600 hover:text-black"
        >
          Change
        </button>
      </div>
      <div class="flex items-center gap-3">
        <div class="flex-1 h-2 bg-gray-100 rounded-full overflow-hidden">
          <div
            class="h-full rounded-full transition-all"
            [class.bg-green-500]="wp.workouts_this_week >= wp.goal"
            [class.bg-amber-500]="wp.workouts_this_week < wp.goal"
            [style.width.%]="wp.goal > 0 ? Math.min(100, (wp.workouts_this_week / wp.goal) * 100) : 0"
          ></div>
        </div>
        <span class="text-sm font-medium text-black shrink-0"
          >{{ wp.workouts_this_week }} / {{ wp.goal }}</span
        >
      </div>
      <p class="text-xs text-gray-500 mt-1">
        {{ wp.workouts_this_week >= wp.goal ? 'Goal reached! Rest days are
        fine.' : (wp.goal - wp.workouts_this_week) + ' more to hit your goal.'
        }}
      </p>
    </div>
    }

    <div *ngIf="loading()" class="text-sm text-gray-500 py-4">
      Loading workouts...
    </div>
    <div
      *ngIf="error()"
      class="text-sm text-gray-700 bg-gray-100 border border-gray-200 rounded-lg p-3 mb-4"
    >
      {{ error() }}
    </div>
    <div class="flex flex-col justify-between gap-1 mb-4">
      <h3 class="text-lg font-semibold text-black">Recent workouts</h3>
      <span class="text-xs font-normal text-gray-500"
        >Your workout history</span
      >
    </div>

    <div class="rounded-lg border border-gray-200 overflow-hidden bg-white">
      @if (!loading() && workouts().length === 0 && !error()) {
      <div class="py-8 text-center text-sm text-gray-500">
        No workouts found.
      </div>
      } @else {
      <div
        *ngFor="let workout of workouts().slice(0, 5); let last = last"
        class="flex items-center justify-between py-3 px-4 border-b border-gray-100 hover:bg-gray-50 transition-colors"
        [class.border-b-0]="last"
      >
        <div>
          <p class="text-sm font-medium text-black">
            {{ workout.workout_datetime | date:'medium' }}
          </p>
          <p class="text-xs text-gray-500 mt-0.5">
            Source: {{ workout.source }}
          </p>
        </div>
      </div>
      }
    </div>
  </div>

  <div class="leaderboard">
    <div class="flex flex-col justify-between gap-1 mb-4">
      <h2 class="text-xl font-semibold text-black">Leaderboard</h2>
      <span class="text-xs font-normal text-gray-500"
        >Most recent workouts</span
      >
    </div>

    <div
      *ngIf="leaderboard().length === 0 && !loading()"
      class="text-xs text-gray-500 py-6"
    >
      No leaderboard data available.
    </div>

    <div class="rounded-lg border border-gray-200 overflow-hidden bg-white">
      <table class="w-full text-xs">
        <thead>
          <tr class="border-b border-gray-200 bg-gray-50">
            <th class="text-left py-2 px-2 font-medium text-gray-500">#</th>
            <th class="text-left py-2 px-3 font-medium text-gray-500">User</th>
            <th class="text-center py-2 px-2 font-medium text-gray-500">
              Streak
            </th>
            <th class="text-right py-2 px-3 font-medium text-gray-500">
              Last workout
            </th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let item of leaderboard().slice(0, 6); let i = index"
            class="border-b border-gray-100 last:border-b-0 hover:bg-gray-50"
          >
            <td class="py-2 px-2 text-gray-400 font-medium">{{ i + 1 }}</td>
            <td class="py-2 px-3 text-black font-medium">
              {{ item.username }}
            </td>
            @if (item.current_streak > 0) {
            <td class="py-2 px-2 text-center">
              <span
                class="inline-flex items-center justify-center gap-1 text-gray-600 font-medium"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                  class="w-3.5 h-3.5 text-amber-500 shrink-0"
                  aria-hidden="true"
                >
                  <path
                    fill-rule="evenodd"
                    d="M12.963 2.286a.75.75 0 0 0-1.071-.136 9.742 9.742 0 0 0-3.539 6.177 7.547 7.547 0 0 1-1.705-1.715.75.75 0 0 0-1.152-.082A9 9 0 1 0 15.68 4.534a7.46 7.46 0 0 1-2.717-2.248Z"
                    clip-rule="evenodd"
                  />
                </svg>
                {{ item.current_streak }} {{ item.current_streak === 1 ? 'week'
                : 'weeks' }}
              </span>
            </td>
            } @if (item.current_streak === 0) {
            <td class="py-2 px-2 text-center">
              <span
                class="inline-flex items-center justify-center gap-1 text-gray-600 font-medium"
              >
                No streak
              </span>
            </td>
            }
            <td class="py-2 px-3 text-right text-gray-500">
              {{ item.last_workout ? (item.last_workout | date:'medium') : '—'
              }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <button
      (click)="logWorkout()"
      [disabled]="hasLoggedToday()"
      class="btn-primary mt-4 w-full px-4 py-3 disabled:opacity-60 disabled:cursor-not-allowed"
    >
      {{ hasLoggedToday() ? 'Already logged today' : 'Log Workout' }}
    </button>
    @if (workoutLoggedFailed()) {
    <p class="mt-3 text-sm font-medium text-gray-700">
      {{ workoutLoggedErrorMsg() || 'Failed to log workout. Please try again.'
      }}
    </p>
    }
  </div>
</div>

@if (showGoalEditor()) {
<app-modal title="Weekly goal" [show]="true" (closed)="closeGoalEditor()">
  <div class="flex flex-wrap justify-center gap-2 mb-4">
    @for (g of [1,2,3,4,5,6,7]; track g) {
    <button
      type="button"
      (click)="editingGoal.set(g)"
      class="w-12 h-12 rounded-lg font-semibold text-sm transition-colors"
      [class.bg-slate-900]="editingGoal() === g"
      [class.text-white]="editingGoal() === g"
      [class.bg-gray-100]="editingGoal() !== g"
      [class.text-gray-700]="editingGoal() !== g"
    >
      {{ g }}
    </button>
    }
  </div>
  <p class="text-sm text-gray-600 text-center mb-4">
    {{ editingGoal() }} {{ editingGoal() === 1 ? 'workout' : 'workouts' }} per
    week
  </p>
  <button
    type="button"
    (click)="saveGoal(editingGoal())"
    class="btn-primary w-full h-10 text-sm"
  >
    Save
  </button>
</app-modal>
}

<app-celebration-overlay
  [show]="workoutLoggedSuccessfully()"
  [type]="celebrationType()"
  [title]="celebrationTitle()"
  [subtitle]="celebrationSubtitle()"
/>
